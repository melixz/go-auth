# go-auth

Сервис аутентификации на Go с использованием PostgreSQL и Docker.

## Описание

Сервис предоставляет четыре эндпоинта API для управления аутентификацией пользователей:
- Получение пары токенов (access и refresh)
- Обновление пары токенов
- Получение GUID текущего пользователя (защищённый роут)
- Деавторизация пользователя

## Технологии

- **Go 1.24+** — основной язык
- **PostgreSQL** — база данных
- **Docker** — контейнеризация
- **JWT** — токены доступа
- **bcrypt** — хеширование refresh токенов
- **Swagger** — документация API

## Структура проекта

```
go-auth/
├── cmd/go-auth/          # Точка входа приложения
├── internal/
│   ├── handlers/         # HTTP обработчики
│   ├── middleware/       # Промежуточное ПО
│   ├── models/          # Модели данных
│   ├── jwt/             # JWT утилиты
│   └── utils/           # Вспомогательные функции
├── migrations/          # Миграции базы данных
├── docs/               # Swagger документация
├── Dockerfile          # Docker образ
└── docker-compose.yml  # Docker Compose конфигурация
```

## Схема авторизации

- **Тип:** ApiKeyAuth (apiKey)
- **Заголовок:** `Authorization`
- **Формат:** `Bearer <access_token>`

## Эндпоинты

### 1. POST /tokens

**Описание:** Получить пару токенов (access и refresh) для пользователя с указанным GUID.

**Параметры запроса:**
- `user_id` (string, обязательный, GUID пользователя) — в query

**Ответ:**
```json
{
  "access_token": "<JWT access token>",
  "refresh_token": "<base64 refresh token>"
}
```

**Коды ответов:**
- `200 OK` — успешно
- `400 Bad Request` — если не передан user_id
- `500 Internal Server Error` — ошибка генерации токенов

### 2. POST /tokens/refresh

**Описание:** Обновить пару токенов. Требует действующую пару access+refresh токенов, выданных вместе.

**Тело запроса:**
```json
{
  "access_token": "<старый access token>",
  "refresh_token": "<старый refresh token>"
}
```

**Особенности:**
- Операция запрещена при изменении User-Agent (пользователь деавторизуется)
- При попытке обновления с нового IP отправляется POST-запрос на webhook (операция разрешена)
- Refresh-токен защищён от повторного использования и изменений на клиенте

**Коды ответов:**
- `200 OK` — новая пара токенов
- `400 Bad Request` — некорректные данные
- `401 Unauthorized` — невалидная пара токенов, попытка повторного использования или смена User-Agent
- `500 Internal Server Error` — внутренняя ошибка

### 3. GET /me

**Описание:** Получить GUID текущего пользователя. **Требует авторизации!**

**Заголовок:**
```
Authorization: Bearer <access_token>
```

**Ответ:**
```json
{
  "user_id": "<GUID пользователя>"
}
```

**Коды ответов:**
- `200 OK` — успешно
- `401 Unauthorized` — невалидный или отсутствующий токен

### 4. POST /logout

**Описание:** Деавторизация пользователя. После вызова этого метода access/refresh токены становятся невалидными.

**Заголовок:**
```
Authorization: Bearer <access_token>
```

**Коды ответов:**
- `204 No Content` — успешно
- `401 Unauthorized` — невалидный или отсутствующий токен


## Запуск

### Переменные окружения

Основные переменные окружения (определяются в `.env`):

- `DATABASE_URL` — строка подключения к PostgreSQL
- `JWT_SECRET` — секретный ключ для подписи JWT токенов
- `WEBHOOK_URL` — URL для отправки уведомлений о попытках входа с нового IP


### Запуск одной командой
```bash
docker-compose -f docker-compose.yml up -d
```

Все настройки берутся из `.env` и конфигурационных файлов по умолчанию.

### Проверка работоспособности
```bash
curl http://localhost:8080/healthz
```

## Swagger документация

После запуска сервиса документация доступна по адресу:
```
http://localhost:8080/swagger/
```

### Пример авторизации в Swagger UI

1. Получите токены через `/tokens?user_id=<ваш_guid>`
2. Нажмите кнопку **Authorize**
3. Введите в поле авторизации:
   ```
   Bearer <access_token>
   ```
4. Нажмите **Authorize**
5. Теперь доступны защищённые эндпоинты
